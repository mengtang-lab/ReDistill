import numpy as np
import matplotlib.pyplot as plt
from matplotlib.ticker import MaxNLocator
font = {'family' : 'Times New Roman',
        # 'weight' : 'bold',
        'size'   : 15}
plt.rc('font', **font)

if __name__ == "__main__":
    # peak memory -- only output
    # info = {
    #     "stl10-MobileNetV2": {
    #         "Teacher": [2.0, 2.0, 6.0, 2.625, 2.25, 0.875, 0.875, 0.75, 0.4375, 0.4375, 0.4375, 0.375, 0.65625, 0.65625, 0.5625, 0.2734375, 0.2734375, 0.234375],
    #         "Student": [0.03125, 0.03125, 0.09375, 0.041015625, 0.03515625, 0.0546875, 0.0546875, 0.046875, 0.109375, 0.109375, 0.109375, 0.09375, 0.1640625, 0.1640625, 0.140625, 0.2734375, 0.2734375, 0.234375],
    #         "RED (ours)": [0.03125, 0.03125, 0.09375, 0.041015625, 0.03515625, 0.0546875, 0.0546875, 0.0625, 0.109375, 0.109375, 0.109375, 0.09375, 0.1640625, 0.1640625, 0.1875, 0.2734375, 0.2734375, 0.234375],
    #     },
    #     "stl10-MobileNetv3_Small": {
    #         "Teacher": [1.0, 0.50006103515625, 1.125, 0.4375, 0.375, 0.50872802734375, 0.50872802734375, 0.234832763671875, 0.32867431640625, 0.28125, 0.306884765625, 0.306884765625],
    #         "Student": [0.0625, 0.03131103515625, 0.0703125, 0.02734375, 0.0472412109375, 0.12786865234375, 0.12786865234375, 0.059051513671875, 0.08258056640625, 0.1417236328125, 0.306884765625, 0.306884765625],
    #         "RED (ours)": [0.0625, 0.03131103515625, 0.125, 0.02734375, 0.125, 0.12786865234375, 0.12786865234375, 0.059051513671875, 0.08258056640625, 0.1417236328125, 0.306884765625, 0.306884765625],
    #     },
    #     "stl10-ResNeXt18": {
    #         "Teacher": [4.0, 5.0, 2.0, 2.0, 1.0, 1.5, 0.5, 0.75, 0.25, 0.375],
    #         "Student": [0.25, 0.5, 0.5, 0.5, 0.125, 0.375, 0.125, 0.1875, 0.25, 0.1875],
    #         "RED (ours)": [0.5, 0.5, 0.5, 0.5, 0.5, 0.375, 0.25, 0.1875, 0.25, 0.1875],
    #     },
    #     "imagenet-ResNet18": {
    #         "Teacher": [3.0625, 3.828125, 1.53125, 1.53125, 0.765625, 1.1484375, 0.3828125, 0.57421875, 0.19140625, 0.287109375],
    #         "Student": [0.19140625, 0.3828125, 0.3828125, 0.3828125, 0.19140625, 0.287109375, 0.095703125, 0.1435546875, 0.19140625, 0.1435546875],
    #         "RED (ours)": [0.3828125, 0.3828125, 0.3828125, 0.3828125, 0.3828125, 0.287109375, 0.19140625, 0.1435546875, 0.19140625, 0.1435546875],
    #     },
    #     "imagenet-ResNet50": {
    #         "Teacher": [3.0625, 3.828125,
    #                     6.125, 3.828125, 3.828125,
    #                     3.0625, 4.59375, 4.59375, 4.59375,
    #                     1.53125, 2.296875, 2.296875, 2.296875, 2.296875, 2.296875,
    #                     0.765625, 1.1484375, 1.1484375],
    #         "Student": [0.19140625, 0.3828125,
    #                     1.53125, 0.95703125, 0.95703125,
    #                     0.765625, 1.1484375, 1.1484375, 1.1484375,
    #                     0.3828125, 0.57421875, 0.57421875, 0.57421875, 0.57421875, 0.57421875,
    #                     0.765625, 0.57421875, 0.57421875],
    #         "RED (ours)": [0.3828125, 0.3828125,
    #                        1.53125, 0.95703125, 0.95703125,
    #                        1.53125, 1.1484375, 1.1484375, 1.1484375,
    #                        0.765625, 0.57421875, 0.57421875, 0.57421875, 0.57421875, 0.57421875,
    #                        0.765625, 0.57421875, 0.57421875],
    #     },
    #     "cifar10-DDPM": {
    #         "Teacher": [0.5,
    #                     1.00048828125, 1.50048828125, 1.125, 1.5009765625, 1.8759765625, 1.6875, 1.8134765625, 1.8759765625, 1.828125, 1.8603515625, 1.8759765625,
    #                     0.0322265625, 0.0322265625,
    #                     0.0478515625, 0.0478515625, 0.0478515625, 0.0625, 0.1884765625, 0.1884765625, 0.1884765625, 0.25, 0.7509765625, 0.7509765625, 0.6259765625, 1.0, 2.00048828125, 1.50048828125, 1.50048828125,
    #                     0.01171875],
    #         "Student": [0.125,
    #                     0.25048828125, 0.37548828125, 0.28125, 0.3759765625, 0.4697265625, 0.421875, 0.4541015625, 0.4697265625, 0.46875, 0.5009765625, 0.5166015625,
    #                     0.0322265625, 0.0322265625,
    #                     0.0478515625, 0.0478515625, 0.0478515625, 0.015625, 0.0478515625, 0.0478515625, 0.0478515625, 0.0625, 0.1884765625, 0.1884765625, 0.1572265625, 0.25, 0.50048828125, 0.37548828125, 0.37548828125,
    #                     0.01171875],
    #         "RED (ours)": [0.25,
    #                     0.25048828125, 0.37548828125, 0.28125, 0.3759765625, 0.4697265625, 0.421875, 0.4541015625, 0.4697265625, 0.46875, 0.5009765625, 0.5166015625,
    #                     0.0322265625, 0.0322265625,
    #                     0.0478515625, 0.0478515625, 0.0478515625, 0.015625, 0.0478515625, 0.0478515625, 0.0478515625, 0.0625, 0.1884765625, 0.1884765625, 0.1572265625, 0.25, 0.50048828125, 0.37548828125, 0.37548828125,
    #                     0.25],
    #     },
    # }

    info = {
        "stl10-MobileNetV2": {
            "Teacher": [2.1875, 4.0, 7.5, 4.875, 2.8125, 1.625, 1.625, 0.9375, 0.8125, 0.8125, 0.8125, 0.75, 1.21875, 1.21875, 0.703125, 0.5078125, 0.5078125, 0.46875],
            "Student": [0.21875, 0.0625, 0.1171875, 0.076171875, 0.0703125, 0.1015625, 0.1015625, 0.09375, 0.203125, 0.203125, 0.203125, 0.1875, 0.3046875, 0.3046875, 0.28125, 0.5078125, 0.5078125, 0.46875],
            "RED (ours)": [0.21875, 0.0625, 0.28125, 0.076171875, 0.0703125, 0.1015625, 0.1015625, 0.09375, 0.203125, 0.203125, 0.203125, 0.1875, 0.3046875, 0.3046875, 0.28125, 0.5078125, 0.5078125, 0.46875],
        },
        "stl10-MobileNetv3_Small": {
            "Teacher": [1.1875, 1.25, 1.40625, 0.78125, 0.46875, 0.50872802734375, 0.50872802734375, 0.234832763671875, 0.32867431640625, 0.3515625, 0.306884765625, 0.306884765625],
            "Student": [0.25, 0.078125, 0.087890625, 0.048828125, 0.0472412109375, 0.12786865234375, 0.12786865234375, 0.059051513671875, 0.08258056640625, 0.1417236328125, 0.306884765625, 0.306884765625],
            "RED (ours)": [0.25, 0.1875, 0.2109375, 0.048828125, 0.0472412109375, 0.12786865234375, 0.12786865234375, 0.059051513671875, 0.08258056640625, 0.1417236328125, 0.306884765625, 0.306884765625],
        },
        "stl10-ResNeXt18": {
            "Teacher": [4.1875, 5.0, 3.0, 3.0, 3.0, 2.0, 1.5, 1.0, 0.75, 0.5],
            "Student": [0.4375, 0.5, 0.75, 0.75, 0.75, 0.5, 0.375, 0.25, 0.4375, 0.3125],
            "RED (ours)": [0.75, 0.5, 0.75, 0.75, 0.75, 0.5, 0.375, 0.25, 0.4375, 0.3125],
        },
        "imagenet-ResNet18": {
            "Teacher": [3.63671875, 3.828125,
                        2.296875, 2.296875,
                        2.296875, 1.53125,
                        1.1484375, 0.765625,
                        0.57421875, 0.3828125],
            "Student": [0.765625, 0.3828125,
                        0.57421875, 0.57421875,
                        0.57421875, 0.3828125,
                        0.287109375, 0.19140625,
                        0.3349609375, 0.2392578125],
            "RED (ours)": [0.765625, 0.3828125,
                           0.57421875, 0.57421875,
                           0.57421875, 0.3828125,
                           0.287109375, 0.19140625,
                           0.3349609375, 0.2392578125],
        },
        "imagenet-ResNet50": {
            "Teacher": [3.63671875, 3.828125,
                        7.65625, 4.59375, 4.59375,
                        9.1875, 4.9765625, 4.9765625, 4.9765625,
                        4.59375, 2.48828125, 2.48828125, 2.48828125, 2.48828125, 2.48828125,
                        2.296875, 1.244140625, 1.244140625],
            "Student": [0.765625, 0.3828125,
                        1.9140625, 1.1484375, 1.1484375,
                        2.296875, 1.244140625, 1.244140625, 1.244140625,
                        1.1484375, 0.6220703125, 0.6220703125, 0.6220703125, 0.6220703125, 0.6220703125,
                        1.052734375, 0.669921875, 0.669921875],
            "RED (ours)": [0.765625, 0.3828125,
                        1.9140625, 1.1484375, 1.1484375,
                        2.296875, 1.244140625, 1.244140625, 1.244140625,
                        1.1484375, 0.6220703125, 0.6220703125, 0.6220703125, 0.6220703125, 0.6220703125,
                        1.052734375, 0.669921875, 0.669921875],
        },
        "cifar10-DDPM": {
            "Teacher": [0.001953125, 0.51171875,
                        1.50048828125, 2.00048828125, 1.125, 1.75, 2.1259765625, 1.6875, 1.8759765625, 1.9384765625, 1.828125, 1.8759765625, 1.8916015625,
                        0.0478515625, 0.0478515625,
                        0.0791015625, 0.0791015625, 0.0791015625, 0.0625, 0.3134765625, 0.3134765625, 0.3134765625, 0.25, 1.2509765625, 1.2509765625, 1.0009765625, 1.0, 3.50048828125, 2.50048828125, 2.50048828125,
                        0.01171875],
            "Student": [0.001953125, 0.13671875,
                        0.37548828125, 0.50048828125, 0.28125, 0.4375, 0.5322265625, 0.421875, 0.4697265625, 0.4853515625, 0.46875, 0.5166015625, 0.5322265625,
                        0.0478515625, 0.0478515625,
                        0.0791015625, 0.0791015625, 0.0791015625, 0.015625, 0.0791015625, 0.0791015625, 0.0791015625, 0.0625, 0.3134765625, 0.3134765625, 0.2509765625, 0.25, 0.87548828125, 0.62548828125, 0.62548828125,
                        0.01171875],
            "RED (ours)": [0.001953125, 0.375,
                           0.37548828125, 0.50048828125, 0.375, 0.4375, 0.5322265625, 0.421875, 0.4697265625, 0.4853515625, 0.46875, 0.5166015625, 0.5322265625,
                           0.0478515625, 0.0478515625,
                           0.0791015625, 0.0791015625, 0.0791015625, 0.015625, 0.0791015625, 0.0791015625, 0.0791015625, 0.1875, 0.3134765625, 0.3134765625, 0.2509765625, 0.75, 0.87548828125, 0.62548828125, 0.62548828125,
                           0.01171875],
        },
    }

    plt.figure(figsize=(16, 8))
    plt.subplots_adjust(wspace=0.24, hspace=0.3)
    colors = ['b', 'r']
    for i, model in enumerate(info.keys()):
        plt.subplot(231+i)

        plt.grid(visible=True)
        markers = ['.', 'o']
        markerfacecolor = ['k', 'none']
        linestyles = ['-', '--']
        for j, method in enumerate(["Teacher", "RED (ours)"]):
            peak_mem = info[model][method]
            plt.plot(np.arange(len(peak_mem)), peak_mem, c=colors[j], marker=markers[j], linestyle=linestyles[j], linewidth=0.8,  markersize=5, markerfacecolor=markerfacecolor[j])
        if i == 5: plt.legend(['Baseline', 'Ours'], bbox_to_anchor=(0.8,1))
        else: plt.legend(['Baseline', 'Ours'], loc="upper right")
        # plt.savefig('./peak_mem.eps', dpi=600, format='eps')
        plt.gca().xaxis.set_major_locator(MaxNLocator(integer=True))
        plt.xlabel("Layer")
        plt.ylabel("Memory (MB)")
        plt.title(f"Memory Footprint - {model.split('-')[1]}")

    plt.savefig(f'./memory_footprint.jpg', dpi=60)
    plt.savefig(f'./memory_footprint.eps', dpi=600, format='eps')